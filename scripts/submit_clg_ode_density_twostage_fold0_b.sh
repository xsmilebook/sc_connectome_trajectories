#!/bin/bash

set -euo pipefail

ROOT="/ibmgpfs/cuizaixu_lab/xuhaoshu/projects/sc_connectome_trajectories"

RUN_BASE_P1="clg_density_twostage_b_p1"
RUN_BASE_P2="clg_density_twostage_b_p2"
RESUME_FROM="${ROOT}/outputs/results/clg_ode/runs/${RUN_BASE_P1}/fold0/clg_ode_fold0_best.pt"

job1="$(sbatch --parsable --export=ALL,CLG_CV_FOLD=0,RUN_BASE=${RUN_BASE_P1},RESIDUAL_SKIP=1,RESIDUAL_TAU=1.0,RESIDUAL_CAP=0.2,LAMBDA_FULL_LOG_MSE=0.05,EARLY_STOP_METRIC=val_sc_log_pearson_sparse,VAL_SC_EVAL_EVERY=1,ADJACENT_PAIR_PROB=1.0,LATENT_DIM=32,HIDDEN_DIM=64,SOLVER_STEPS=6,MAX_EPOCHS=40,PATIENCE=15,BATCH_SIZE=2,LEARNING_RATE=1e-4,LAMBDA_KL=0,LAMBDA_TOPO=0,LAMBDA_VEL=0,LAMBDA_ACC=0,GRADNORM_SCOPE=none,SC_POS_EDGE_DROP_PROB=0,MORPH_NOISE_SIGMA=0,LAMBDA_ZERO_LOG=0.0,LAMBDA_DENSITY=0.0 scripts/submit_clg_ode.sh)"
echo "Phase-1 submitted: ${job1} (RUN_BASE=${RUN_BASE_P1})"

job2="$(sbatch --parsable --dependency=afterok:${job1} --export=ALL,CLG_CV_FOLD=0,RUN_BASE=${RUN_BASE_P2},RESUME_FROM=${RESUME_FROM},RESIDUAL_SKIP=1,RESIDUAL_TAU=1.0,RESIDUAL_CAP=0.2,LAMBDA_FULL_LOG_MSE=0.05,LAMBDA_ZERO_LOG=0.02,ZERO_LOG_WARMUP_EPOCHS=0,ZERO_LOG_RAMP_EPOCHS=0,LAMBDA_DENSITY=0.01,DENSITY_WARMUP_EPOCHS=2,DENSITY_RAMP_EPOCHS=20,EARLY_STOP_METRIC=monitor_mse_plus_density,EARLY_STOP_DENSITY_WEIGHT=0.01,VAL_SC_EVAL_EVERY=1,ADJACENT_PAIR_PROB=1.0,LATENT_DIM=32,HIDDEN_DIM=64,SOLVER_STEPS=6,MAX_EPOCHS=80,PATIENCE=25,BATCH_SIZE=2,LEARNING_RATE=2e-5,LAMBDA_KL=0,LAMBDA_TOPO=0,LAMBDA_VEL=0,LAMBDA_ACC=0,GRADNORM_SCOPE=none,SC_POS_EDGE_DROP_PROB=0,MORPH_NOISE_SIGMA=0 scripts/submit_clg_ode.sh)"
echo "Phase-2 submitted: ${job2} (depends on ${job1}, RUN_BASE=${RUN_BASE_P2})"

