# 2026-01-15 会话记录

## 变更摘要

- 修复 `scripts/submit_clg_ode.sh`：强制使用 `python3` 渲染路径并在路径缺失时中止，避免 `subject_info_csv` 为空导致训练失败。
- 更新 `PROGRESS.md` 记录本次修复。
- 进一步加固路径解析：渲染失败时直接报错退出，并避免未定义变量触发脚本中止。
- 将 `scripts/submit_clg_ode.sh` 的工作目录与日志路径改为绝对路径，避免相对路径导致 Slurm 无日志输出。
- 调整 `scripts/submit_clg_ode.sh`：将 `set -euo pipefail` 移到 `#SBATCH` 之后，避免调度指令被忽略而回落到默认 `slurm-<jobid>.out`。
- 修复 `scripts.render_paths` 调用方式：使用单个 `--set` 参数包含所有路径键，避免只导出最后一个变量导致路径缺失。
- 增加 CLG-ODE 分布式训练支持（DDP），并将提交脚本调整为 4 卡与 48 小时上限，补充相关文档说明。
- 增加 CLG-ODE 的 Tiered 训练目标，使 1/2/3 个时间点的被试都可参与训练（`L_manifold/L_vel/L_acc` + warmup）。
- 增加运行目录命名与记录追溯：默认在 `--results_dir/runs/<timestamp>_job<jobid>/` 保存 `args.json`、`run_meta.json`、`metrics.csv`。
- 新增严格文件存在性的数据分层统计脚本 `python -m scripts.report_clg_ode_tiers`，并在 `docs/reports/` 生成最新 Tier 报告。
- 扩展 session 解析以兼容更多命名模式（含 `6YearFollowUpYArm1`）。
- 修复 `scripts/build_torch_gnn_container.sh`：使用 `python3` 渲染容器路径，避免登录节点默认 Python2 导致导入失败。
- 增加测试集 SC 评估指标（`log(1+A)` 的 MSE/MAE/pearson + ECC 相似性），写入 `test_sc_metrics.json`。
- 测试评估改为固定 `t0→t1` 配对，ECC 评估对预测矩阵做 top-k 稀疏化（k 取真实正边数）。
- 增加 `--cv_fold` 参数支持按 fold 拆分训练（适合单卡 Slurm array 提交）。
- 更新 `scripts/submit_clg_ode.sh`：默认单卡并可用 Slurm array 按 fold 提交。
- 将 CLG-ODE 日志输出迁移到 `outputs/logs/clg_ode/` 并为 `torchrun` 自动选择 `master_port`。
- 将按 fold 的输出统一归档到 `runs/<time>_job<array_job_id>/fold{0..4}` 目录结构下。
- 调整 CLG-ODE 默认训练参数：更长训练/早停、更高 ODE 步数、更强速度/加速度权重，并启用小幅 KL。
- 增加实验性拓扑损失：基于 Betti curve（β0/β1）约束连通分量与环结构（偏离 locked spec）。
- 测试评估增加稀疏对齐相关性：`sc_log_pearson_pos` 与 `sc_log_pearson_topk`。
- 增加稀疏化后的全图 Pearson：`sc_log_pearson_sparse`。
- 训练中对预测权重做 top-k 稀疏化，用于权重回归与拓扑损失。
