# 会话记录：2026-01-20

## 目标

- 整理并汇总已完成的 density 收敛性实验（10 个任务，fold0），并撰写报告文档。

## 已完成实验

运行目录（均为 fold0）：

- 网格实验（8 个）：`outputs/results/clg_ode/runs/clg_density_w{2,5}_ld{002,005,01,02}/fold0/`
- 两阶段训练（2×2 个 run）：`outputs/results/clg_ode/runs/clg_density_twostage_{a,b}_p{1,2}/fold0/`

## 结果汇总

- 报告：`docs/reports/clg_ode_density_convergence_fold0_20260120.md`
- `val_sc_log_pearson_sparse` 作为 early stopping 监控后，训练长度较上一轮更长，但 `val_density` 仍未接近 0（密度约束未呈现明显“收敛到对齐边数”的行为）。
- top-k/sparse 指标在不同 `lambda_density/warmup` 网格之间差异较小，尚不足以得出稳定结论。

## 文档更新

- `docs/workflow.md`：补充 density 10 实验批量提交与报告链接。
- `PROGRESS.md`：记录本轮结果整理与报告产出。

## 下一步实验设计（根因定位）

为避免继续“盲扫 `lambda_density`”，新增一套 10 任务实验包用于定位：

- `sum(p_hat)/k` 是否长期 `>>1`（过稠密）
- top-k 位置是否正确（`precision@k/recall@k/AUPRC`）
- 是否为 `L_edge` 的 `pos_weight` 推高导致 density 对抗不动
- focal 是否比调 `pos_weight` 更稳

批量提交脚本（用户执行）：

```bash
bash scripts/submit_clg_ode_mask_rootcause_10exp_batch.sh
```

新增的诊断字段会写入每个 run 的 `metrics.csv`，便于直接画曲线（`val_mask_ratio`、`val_mask_precision_at_k`、`val_mask_auprc` 等）。

## 根因定位实验结果（fold0 已完成）

运行目录：

- `outputs/results/clg_ode/runs/clg_maskdiag_fold0/fold0/`
- `outputs/results/clg_ode/runs/clg_pw{1,2,5}_ld{0,0.01,0.05}/fold0/`
- `outputs/results/clg_ode/runs/clg_focal_ld01/fold0/`

关键结论（简要）：

- `pos_weight` 对 `sum(p_hat)/k`（`val_mask_ratio`）影响显著：`pos_weight=5` 更倾向于 `ratio>=1`，`pos_weight=1/2` 普遍 `ratio<1`，提示 BCE 正样本权重可能是“密度压不下来”的主要驱动力之一。
- 仅用 density 约束很难修复“位置不对”：`precision@k` 与 `AUPRC` 在不同配置下都很低（~0.08/~0.07），变化不大，说明 mask 的 top-k 位置预测仍偏离真值。
- focal 能在不显式调 `pos_weight` 的情况下把 `ratio` 拉到更合理范围，并提升 sparse/topk pearson，但仍未显著改善 `precision@k/AUPRC`。

详细表格与建议见报告：`docs/reports/clg_ode_mask_rootcause_fold0_20260120.md`。

## 方案确认与取舍（不做交叉验证）

- 基于 `docs/final_plan.md` 更新交付版评估设置：取消交叉验证，仅报告单一 fold（默认 fold0）以节省时间；如需稳健性，建议追加 1 个 fold 做趋势一致性核对（不要求 5-fold 平均）。
- 同步更新 `docs/methods.md` 中的数据划分描述：保留 GroupKFold 作为 train/val 构造方式，但推荐单 `--cv_fold` 快速迭代。
- 更新 Δt 分层口径：用测试对 `dt_months` 的分位数切分（Short ≤P33、Long ≥P67；可选 Mid），并在报告中写出 P33/P67 对应的具体月份阈值与样本量（例如 “Short（≤4.8 months, n=xxx），Long（≥13.2 months, n=xxx）”）。
- 固定创新模块默认超参（N=400）：`K_new=80`、`TopM=400`、`g(dt)=min(1, dt_months/12)`、`q=g(dt)*sigmoid((s_new-δ)/τ)`（`τ=0.10`、`δ=P95`）、focal（`gamma=2, alpha=0.25`）+ `L_new_sparse=mean(q)`（`λ` 从 0→0.10 ramp，epoch 0–10 关闭、10–20 线性上升、≥20 保持）。
- 进一步澄清符号定义：`s_new` 取创新 head 的 raw logit/score（pre-sigmoid、未乘 `g(dt)`、未减 `δ`）；`δ` 按“每个样本、仅 `m0=0` 的候选 TopM 边集合”计算 P95。

## 工程实现：fixed-support + 保守新增边

- 实现 `--fixed_support`：主干 residual 分支在 `A0>0` 支持集上学习/预测，避免新边由主干直接引入。
- 实现 `--innovation_enabled`：在 `A0=0` 的边上按 `l_new` 选 TopM 候选，逐样本计算 `δ=P95`，并用 `q=g(dt)*sigmoid((l_new-δ)/τ)` 做 TopK(K_new) 放行与 `mean(q)` 稀疏惩罚（含 epoch warmup/ramp）。
- 新增 fold0 提交模板：`scripts/submit_clg_ode_fixedsupport_innovation_fold0.sh`（用户提交）。
- 新增对照/消融提交模板（fold0，用户提交）：`scripts/submit_identity_baseline_sc_eval.sh`、`scripts/submit_clg_ode_baseline_original_fold0.sh`、`scripts/submit_clg_ode_fixedsupport_residual_fold0.sh`、`scripts/submit_clg_ode_fixedsupport_no_dt_gate_fold0.sh`、`scripts/submit_clg_ode_fixedsupport_no_Lsmall_fold0.sh`、`scripts/submit_clg_ode_fixedsupport_no_residual_fold0.sh`。

## 故障修复（Slurm job 13702791）

- 报错原因：创新模块在 GPU 上运行时，使用 NumPy `triu_idx` 与 CUDA tensor 混合索引，触发 `can't convert cuda:0 device type tensor to numpy`。
- 修复：将 `triu_idx` 转为同 device 的 torch 索引再进行候选选择与 mask 构造；并允许在提交脚本里通过环境变量覆盖 `RUN_BASE/CLG_CV_FOLD` 便于重跑。
