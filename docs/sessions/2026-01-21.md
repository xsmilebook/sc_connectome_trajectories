# 会话记录：2026-01-21

## 目标

- 确认 fold0 的所有对照/消融/创新模块任务均已完成。
- 汇总关键指标并撰写阶段性报告。

## 输入与范围

- 仅整理 `outputs/results/clg_ode/runs/*/fold0/` 下已生成的 `clg_ode_results.json/test_sc_metrics.json/metrics.csv`。
- 不改动任何 `outputs/` 或 `data/` 下的运行产物。

## 完成内容

- 定位并确认：`outputs/logs/clg_ode/13702673.out` 对应 `clg_focal_ld01`（focal baseline），非 D2。
- 汇总 fold0 的 Baselines/消融/D2（innovation）在测试集上的关键指标，并形成对比表与结论。
- 产出报告：
  - `docs/reports/clg_fold0_fixedsupport_innovation_report_20260121.md`
- 设计下一轮唯一新增实验（D2′）：更保守的 innovation + 冻结主干 + 仅长间隔启用；并补齐新增边/零边区域评测指标，避免新增边收益在全图指标中被淹没。

## D2′ 运行情况与修复

- job `13702869`（`clg_d2prime_long_freeze/fold0`）在 epoch 11 冻结主干后崩溃：`RuntimeError: element 0 of tensors does not require grad...`。
- 根因：冻结后若采样到的都是短间隔对（dt<9mo），innovation gate=0，导致整批 loss 不含任何可回传梯度的项；随后 `loss.backward()` 触发报错。
- 修复：训练阶段检测 `loss.requires_grad`，无梯度则跳过反传；并在 innovation-only 阶段偏向采样更长间隔对（避免 gate 长期为 0）。

## D2′（rerun1）结果检查

- run：`outputs/results/clg_ode/runs/clg_d2prime_long_freeze_rerun1/fold0/`
- 结论：D2′ 的主干指标显著劣于 C2/D2，且新增边指标（`new_edge_precision_at_knew/new_edge_auprc` 等）非常低，未达成“主干不掉 + 新增边明显变好”的目标。
- 报告：`docs/reports/clg_d2prime_result_20260121.md`

## 结论摘要（1 行）

- fixed-support + residual 系列在 `sc_log_mse` 与稀疏口径（topk/sparse）上优于 identity baseline，但在全上三角 Pearson 上仍略低；当前默认超参下 D2（保守新增边）未带来整体指标增益，建议作为可选模块并补充新边专用指标后再评估。

## 补充：落实 D2′ 的“从 C2 resume”版本（避免主干退化）

- 更新 `scripts/submit_clg_ode_d2prime_fold0.sh`：默认从 `C2` checkpoint（`clg_fs_no_Lsmall/fold0/clg_ode_fold0_best.pt`）恢复，并从 epoch 0 冻结主干，仅训练 innovation head；同时将 `new_sparse_warmup_epochs=0`、缩短 `max_epochs/patience` 以节省时间。
- 更新文档：在 `docs/final_plan.md` 与 `docs/workflow.md` 中明确 D2′ 必须“resume + freeze”，避免从零训练导致 backbone underfit 的失败模式。

## 补充：扩展拓扑评估与评估-only 提交

- 为补足 ECC 指标之外的拓扑证据，在测试评估中新增 **度分布/强度分布** 指标（MAE/RMSE/Pearson/KS）。
- 新增评估-only 入口 `python -m scripts.eval_clg_ode_run` 与提交脚本 `scripts/submit_clg_ode_eval.sh`，用于对已有 run 目录在测试集上复评估并写出 `test_sc_metrics_ext.json`（不重训）。
- 提供批量提交脚本 `scripts/submit_clg_ode_eval_report_models_fold0.sh`：报告常用模型一键提交（每个模型一个 sbatch 任务，由用户执行）。
